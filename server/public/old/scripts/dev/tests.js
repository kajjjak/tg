///localStorage.clear();
//test_state_poorattack = "{\"xp\":{\"level\":1,\"required\":50,\"count\":3,\"total\":3},\"search\":{\"radius\":3,\"factor\":100},\"currencies\":{\"gold\":{},\"wood\":{},\"iron\":{},\"stone\":{}},\"storage_capacity\":{\"gold\":3000,\"wood\":2000,\"iron\":null,\"stone\":null,\"diamonds\":1010},\"storage_contents\":{\"gold\":308,\"wood\":32,\"iron\":0,\"stone\":0,\"diamonds\":1010,\"iap\":27},\"ledgers\":{\"gold\":{\"currency\":\"gold\",\"accounts\":{\"cash\":0,\"build\":308,\"time\":-308},\"amount\":308,\"records\":[{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":2}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"gold\",\"gold\":244}}]},\"iron\":{\"currency\":\"iron\",\"accounts\":{\"cash\":0},\"amount\":0,\"records\":[]},\"wood\":{\"currency\":\"wood\",\"accounts\":{\"cash\":0,\"build\":32,\"time\":-32},\"amount\":32,\"records\":[{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"IAP wood\",\"wood\":100,\"diamonds\":1000,\"iap\":-1}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"type\":\"snipertower\",\"category\":\"defense\",\"level\":1,\"hit_points\":1700,\"dps\":40,\"upgrade_wood\":100,\"upgrade_time_str\":\"3s\",\"head_quarter\":1,\"upgrade_time\":3,\"preview\":\"http://img2.wikia.nocookie.net/__cb20140330025120/boombeach/images/thumb/d/d7/snipertower_lvl1.jpg/100px-snipertower_lvl1.jpg\",\"image_level\":\"01\",\"icon_level\":\"01\",\"actor_type\":\"ballistic\",\"damage_now\":0,\"damage_max\":4,\"weapon_damage\":1,\"weapon_sound\":\"gunshot1\",\"price_placing\":10,\"price_corpse\":2,\"price_building\":2,\"price_reperation\":2,\"price_removing\":0,\"rotation_offset\":0,\"rotation_transition\":true,\"rotation_speed\":500,\"placement_duration\":1000,\"placement_sound\":null,\"placement_sound_complete\":null,\"transition_speed\":100,\"actor_count\":3,\"wood\":-100,\"time_str\":null,\"time\":-3}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"wood\",\"wood\":32}}]},\"stone\":{\"currency\":\"stone\",\"accounts\":{\"cash\":0},\"amount\":0,\"records\":[]},\"diamonds\":{\"currency\":\"diamonds\",\"accounts\":{\"cash\":0,\"build\":1010,\"time\":-1010},\"amount\":1010,\"records\":[{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"IAP wood\",\"wood\":100,\"diamonds\":1000,\"iap\":-1}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"Startup of diamonds\",\"diamonds\":10,\"time\":20,\"iap\":-2}}]},\"iap\":{\"currency\":\"iap\",\"accounts\":{\"cash\":0,\"build\":27,\"time\":-27},\"amount\":27,\"records\":[{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"IAP\",\"iap\":10}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"IAP\",\"iap\":10}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"IAP\",\"iap\":10}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"IAP wood\",\"wood\":100,\"diamonds\":1000,\"iap\":-1}},{\"debet\":\"build\",\"credit\":\"time\",\"item\":{\"account\":\"resource\",\"name\":\"Startup of diamonds\",\"diamonds\":10,\"time\":20,\"iap\":-2}}]}},\"game_mode\":\"economy\",\"inventory\":{\"1400768206886\":{\"id\":1400768206886,\"created\":1400768206886,\"type\":\"headquarters\",\"level\":1,\"category\":\"headquarters\",\"gui\":{\"id\":\"building_actor_1400768206886\",\"location_id\":\"4e086ef6a809495e619e9360\",\"position\":[64.13899078547044,-21.870940794090185],\"type\":\"building\",\"base_class\":\"actor_building\",\"actor\":\"building\",\"item_level\":1,\"item_type\":\"headquarters\",\"properties\":{\"item_id\":1400768206886,\"item_level\":1,\"item_type\":\"headquarters\",\"actor_type\":\"building\",\"damage_now\":1,\"damage_max\":1,\"weapon_damage\":0,\"weapon_sound\":null,\"price_placing\":10,\"price_corpse\":0,\"price_building\":0,\"price_reperation\":0,\"price_removing\":0,\"rotation_offset\":0,\"rotation_transition\":true,\"rotation_speed\":0,\"placement_duration\":0,\"placement_sound\":null,\"placement_sound_complete\":null,\"transition_speed\":0},\"infowindow\":\"<div id='1400768206886' class='infowindow_background'>Headquarters<div onclick='btnItemPayout(this)'><span class='item_state'>&nbsp</span></div> <span class='progress'>&nbsp</span><br><img class='infowindow_buttons' src='/media/images/icon_popup_info.png' onclick='btnDetailsItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_upgrade.png' onclick='btnUpgradeItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_attack.png' onclick='btnAttackFromItem(this)'/></div>\",\"icon_level\":\"/media/images/image_headquarters_level_01.png\"},\"_time_callback_length\":null,\"_time_callback_starts\":1400768209608,\"_time_callback_ends\":1400768209708,\"state\":2},\"1400768360234\":{\"id\":1400768360234,\"created\":1400768360234,\"type\":\"snipertower\",\"level\":1,\"category\":\"defense\",\"gui\":{\"id\":\"building_actor_1400768360234\",\"location_id\":\"4d52acacbd6ff04d576bfe0c\",\"position\":[64.13733835970723,-21.859660148620605],\"type\":\"building\",\"base_class\":\"actor_building\",\"actor\":\"building\",\"item_level\":1,\"item_type\":\"snipertower\",\"properties\":{\"item_id\":1400768360234,\"item_level\":1,\"item_type\":\"snipertower\",\"actor_type\":\"building\",\"damage_now\":1,\"damage_max\":1,\"weapon_damage\":0,\"weapon_sound\":null,\"price_placing\":10,\"price_corpse\":0,\"price_building\":0,\"price_reperation\":0,\"price_removing\":0,\"rotation_offset\":0,\"rotation_transition\":true,\"rotation_speed\":0,\"placement_duration\":0,\"placement_sound\":null,\"placement_sound_complete\":null,\"transition_speed\":0},\"infowindow\":\"<div id='1400768360234' class='infowindow_background'>Snipertower<div onclick='btnItemPayout(this)'><span class='item_state'>&nbsp</span></div> <span class='progress'>&nbsp</span><br><img class='infowindow_buttons' src='/media/images/icon_popup_info.png' onclick='btnDetailsItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_upgrade.png' onclick='btnUpgradeItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_attack.png' onclick='btnAttackFromItem(this)'/></div>\",\"icon_level\":\"/media/images/image_snipertower_level_01.png\"},\"_time_callback_length\":null,\"_time_callback_starts\":1400768362755,\"_time_callback_ends\":1400768362855,\"state\":2},\"1400768650870\":{\"id\":1400768650870,\"created\":1400768650870,\"type\":\"captured\",\"level\":1,\"category\":\"builder\",\"gui\":{\"item_level\":1,\"item_type\":\"captured\",\"position\":[64.135429,-21.86275],\"id\":\"building_actor_1400768650870\",\"properties\":{\"item_id\":1400768650870,\"item_level\":1,\"item_type\":\"captured\",\"actor_type\":\"building\",\"damage_now\":1,\"damage_max\":1,\"weapon_damage\":0,\"weapon_sound\":null,\"price_placing\":10,\"price_corpse\":0,\"price_building\":0,\"price_reperation\":0,\"price_removing\":0,\"rotation_offset\":0,\"rotation_transition\":true,\"rotation_speed\":0,\"placement_duration\":0,\"placement_sound\":null,\"placement_sound_complete\":null,\"transition_speed\":0},\"infowindow\":\"<div id='1400768650870' class='infowindow_background'>Captured<div onclick='btnItemPayout(this)'><span class='item_state'>&nbsp</span></div> <span class='progress'>&nbsp</span><br><img class='infowindow_buttons' src='/media/images/icon_popup_info.png' onclick='btnDetailsItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_upgrade.png' onclick='btnUpgradeItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_attack.png' onclick='btnAttackFromItem(this)'/></div>\",\"icon_level\":\"/media/images/image_captured_level_01.png\",\"type\":\"building\"},\"_time_callback_length\":15000000.000000002,\"_time_callback_starts\":1400768680995,\"_time_callback_ends\":1400783680995,\"state\":3,\"_time_builder_starts\":1400768680995,\"_time_builder_ends\":15000000.000000002},\"1400768651856\":{\"id\":1400768651856,\"created\":1400768651856,\"type\":\"captured\",\"level\":1,\"category\":\"builder\",\"gui\":{\"item_level\":1,\"item_type\":\"captured\",\"position\":[64.135429,-21.86275],\"id\":\"building_actor_1400768651856\",\"properties\":{\"item_id\":1400768651856,\"item_level\":1,\"item_type\":\"captured\",\"actor_type\":\"building\",\"damage_now\":1,\"damage_max\":1,\"weapon_damage\":0,\"weapon_sound\":null,\"price_placing\":10,\"price_corpse\":0,\"price_building\":0,\"price_reperation\":0,\"price_removing\":0,\"rotation_offset\":0,\"rotation_transition\":true,\"rotation_speed\":0,\"placement_duration\":0,\"placement_sound\":null,\"placement_sound_complete\":null,\"transition_speed\":0},\"infowindow\":\"<div id='1400768651856' class='infowindow_background'>Captured<div onclick='btnItemPayout(this)'><span class='item_state'>&nbsp</span></div> <span class='progress'>&nbsp</span><br><img class='infowindow_buttons' src='/media/images/icon_popup_info.png' onclick='btnDetailsItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_upgrade.png' onclick='btnUpgradeItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_attack.png' onclick='btnAttackFromItem(this)'/></div>\",\"icon_level\":\"/media/images/image_captured_level_01.png\",\"type\":\"building\"},\"_time_callback_length\":15000000.000000002,\"_time_callback_starts\":1400768681976,\"_time_callback_ends\":1400783681976,\"state\":3,\"_time_builder_starts\":1400768681976,\"_time_builder_ends\":15000000.000000002},\"1400768651867\":{\"id\":1400768651867,\"created\":1400768651867,\"type\":\"captured\",\"level\":1,\"category\":\"builder\",\"gui\":{\"item_level\":1,\"item_type\":\"captured\",\"position\":[64.135429,-21.86275],\"id\":\"building_actor_1400768651867\",\"properties\":{\"item_id\":1400768651867,\"item_level\":1,\"item_type\":\"captured\",\"actor_type\":\"building\",\"damage_now\":1,\"damage_max\":1,\"weapon_damage\":0,\"weapon_sound\":null,\"price_placing\":10,\"price_corpse\":0,\"price_building\":0,\"price_reperation\":0,\"price_removing\":0,\"rotation_offset\":0,\"rotation_transition\":true,\"rotation_speed\":0,\"placement_duration\":0,\"placement_sound\":null,\"placement_sound_complete\":null,\"transition_speed\":0},\"infowindow\":\"<div id='1400768651867' class='infowindow_background'>Captured<div onclick='btnItemPayout(this)'><span class='item_state'>&nbsp</span></div> <span class='progress'>&nbsp</span><br><img class='infowindow_buttons' src='/media/images/icon_popup_info.png' onclick='btnDetailsItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_upgrade.png' onclick='btnUpgradeItem(this)'/> <img class='infowindow_buttons' src='/media/images/icon_popup_attack.png' onclick='btnAttackFromItem(this)'/></div>\",\"icon_level\":\"/media/images/image_captured_level_01.png\",\"type\":\"building\"},\"_time_callback_length\":15000000.000000002,\"_time_callback_starts\":1400768681991,\"_time_callback_ends\":1400783681991,\"state\":3,\"_time_builder_starts\":1400768681991,\"_time_builder_ends\":15000000.000000002}}}"
var state_name = cacheStorageLoad("test_state");
if (state_name){
	var test_state = cacheStorageLoad(state_name);
	if(test_state){
		cacheStorageSave("state", test_state);	
	}else{
		cacheStorageRemove("state");	
	}
	
}




//// retesting the battles


function saveBattleLocation(){
    cacheStorageSave("resource_locations", JSON.stringify(resource_locations));
    cacheStorageSave("location_id", JSON.stringify(location_id));
    cacheStorageSave("bounty_list", JSON.stringify(bounty_list));
}


/* developer debug starts */
function mergeWithTests(){
	return;
    var developer_config = JSON.parse(cacheStorageLoad("battle_defender") || "null") || null;
    if(developer_config){
	    for(var j in ii_defence){
	    	var a = ii_defence[j].type;
			for (var p in ii_defence[j]){
				if(developer_config[a][p]){
					ii_defence[j][p] = developer_config[a][p];
				}
			}
	    }
    }    

	developer_config = JSON.parse(cacheStorageLoad("battle_attacker") || "null") || null;
	if(developer_config){
		//param.properties = $.extend({}, developer_config[param.actor] || {}, param.properties);
		//for(var i in developer_config[param.actor]){ param.properties[i] = developer_config[param.actor][i]; }
	    for(var j in ii_troops){
	    	var a = ii_troops[j].type;
			for (var p in ii_troops[j]){
				if(developer_config[a][p]){
					ii_troops[j][p] = developer_config[a][p];
				}
			}
	    }
	}


};
/* developer debug ends */

setTimeout(function(){
	if (cacheStorageLoad("location_id")){runDefendLocationEscapeRoute();}
}, 4000);



/*
	Authentication and login tests

	Basic domain authentication (chrome)
		- DOMAIN: New player finds the game and starts playing it, then exits early sees warning, creates account
		- DOMAIN: Exits logout - OK
		- DOMAIN: Login should restore game, play then exit (no logout) - OK
		- DOMAIN: Login as another FB user and should restore his game correctly - 
	Basic social authentication (safari)
		- FACEBOOK: New player finds the game and starts playing it, then exits early sees warning, creates account
		- FACEBOOK: Exits logout
		- FACEBOOK: Login should restore game, play then exit (no logout)
		- FACEBOOK: Login as another FB user and should restore his game correctly
	Social tests (firefox)
		- FACEBOOK: New player sees request invite and selects it then plays and creates account
		- FACEBOOK: Sees share and selects it then continues in game
				https://apps.facebook.com/urbanbattlesrvtst/?fb_source=notification&request_ids=1505504556400287&ref=notif&app_request_type=user_to_user&notif_t=app_invite
		- FACEBOOK: Sees request and selects it then continues in game
				calling "/api/social/request/" -- {"data":[{"application":{"name":"Urban Battle Map - Server test","namespace":"urbanbattlesrvtst","id":"248418481997473"},"created_time":"2014-11-12T23:39:17+0000","data":"{\"type\":\"attack_location\",\"data\":{\"name\":\"Te & Kaffi\",\"attack_level\":3,\"gold\":168,\"wood\":6,\"xp\":5,\"gold_budget\":140,\"id\":\"4bf7ef695efe2d7f6bbc6934\",\"location\":{\"lat\":64.14561151636764,\"lng\":-21.92824959754944}}}","from":{"id":"1458107131123544","name":"John Amggbhaceada Panditwitz"},"message":"Help me in securing Te & Kaffi of zombies","to":{"id":"1491083887820547","name":"Sharon Amgefhejeaia Narayananwitz"},"id":"528937340542731_1491083887820547"},{"application":{"name":"Urban Battle Map - Server test","namespace":"urbanbattlesrvtst","id":"248418481997473"},"created_time":"2014-11-12T08:29:47+0000","data":"{\"type\":\"attack_location\",\"data\":{\"name\":\"CINTAMANI\",\"attack_level\":3,\"gold\":168,\"wood\":6,\"xp\":5,\"gold_budget\":140,\"id\":\"4d9f358d925f236af70b4a44\",\"location\":{\"lat\":64.14665,\"lng\":-21.933812}}}","from":{"id":"1458107131123544","name":"John Amggbhaceada Panditwitz"},"message":"Help me in securing CINTAMANI of zombies","to":{"id":"1491083887820547","name":"Sharon Amgefhejeaia Narayananwitz"},"id":"275471079243355_1491083887820547"},{"application":{"name":"Urban Battle Map - Server test","namespace":"urbanbattlesrvtst","id":"248418481997473"},"created_time":"2014-11-12T08:29:12+0000","data":"{\"type\":\"attack_location\",\"data\":{\"name\":\"Bakarí Sandholt\",\"attack_level\":3,\"gold\":168,\"wood\":6,\"xp\":5,\"gold_budget\":140,\"id\":\"4b0588aff964a520f4d322e3\",\"location\":{\"lat\":64.145121,\"lng\":-21.926212}}}","from":{"id":"1458107131123544","name":"John Amggbhaceada Panditwitz"},"message":"Help me in securing Bakarí Sandholt of zombies","to":{"id":"1491083887820547","name":"Sharon Amgefhejeaia Narayananwitz"},"id":"954222704591241_1491083887820547"}],"paging":{"cursors":{"before":"NTI4OTM3MzQwNTQyNzMxOjEwMDAwNzU2ODUwNTE5MQ==","after":"OTU0MjIyNzA0NTkxMjQxOjEwMDAwNzU2ODUwNTE5MQ=="}}}
		- FACEBOOK: Opens a friends notification and continues in game
	No FB cookies (canary)
		- CLEAR CACHE: new player finds game, selects, plays and registers https://apps.facebook.com/urban...
		- CLEAR CACHE: login to FB select game and continue playing https://apps.facebook.com/urban...
		- CLEAR CACHE: play and create new account in https://www.urban...
		- CLEAR CACHE: login through game and play https://www.urban...


PURCHASE
  	Object { error_code: 1383132, error_message: "Application is not tosed by user" }
  	

*/
